<%= jquery do %>
  $("#addon-workflow-agents-addons-approver").remove();

  var state = $("#item_state").parent();
  state.prev().remove();
  state.remove();

  <% if @item.try(:public?) && @cur_site.close_confirmation_enabled? %>
  $(".save").attr("data-close-confirmation", "<%= @item.state %>");
  <% contains_urls_path = url_for(action: 'contains_urls') rescue nil %>
  <% if contains_urls_path && @contains_urls.present? %>
  $(".save").attr("data-contain-links-path", "<%= contains_urls_path %>");
  <% end %>
  <% end %>

  <% if @item.allowed?(:release, @cur_user, site: @cur_site) %>
  $(".save").val("<%= t("ss.buttons.draft_save") %>");
  $("<input />").attr("type", "submit")
    .attr("name", "publish_save")
    .attr("value", "<%= t("ss.buttons.publish_save") %>")
    .attr("class", "publish_save")
    .insertAfter("#item-form input.save");
  <% end %>

  $(".save").on("click", function(e) {
    $("<input />").attr("type", "hidden")
      .attr("name", "item[state]")
      .attr("value", "closed")
      .appendTo("#item-form");
  });

    <% if @item.state == "closed" && @item.workflow_state == "request" %>
    $("<input />").attr("type", "hidden")
      .attr("name", "item[workflow_cancel_request]")
      .attr("value", true)
      .appendTo("#item-form");
    <% end %>

  $(".publish_save").on("click", function(e) {
    $("<input />").attr("type", "hidden")
      .attr("name", "item[state]")
      .attr("value", "public")
      .appendTo("#item-form");
    $("<input />").attr("type", "hidden")
      .attr("name", "item[workflow_reset]")
      .attr("value", "1")
      .appendTo("#item-form");
  });

  Form_Save_Event.render();

  var linePostConfirm = function() {
    var linePostEnabled, lineTokenEnabled, linePosted, lineAutoPost, lineEditAutoPost;

    linePostEnabled = <%== @item.class.include?(Cms::Addon::LinePoster) %>;
    lineTokenEnabled = <%== @cur_site.line_token_enabled? %>
    lineAutoPost = $('[name="item[line_auto_post]"]').length && ($('[name="item[line_auto_post]"]').val() == "active");
    lineEditAutoPost = $('[name="item[line_edit_auto_post]"]').length && ($('[name="item[line_edit_auto_post]"]').val() == "active");

    <% item = (@item.respond_to?(:master) && @item.master) ? @item.master : @item %>
    linePosted = <%== item.respond_to?(:line_posted) && item.line_posted.present? %>;

    if (!linePostEnabled) { return false; }
    if (!lineTokenEnabled) { return false; }
    if (!lineAutoPost) { return false; }
    if (linePosted && !lineEditAutoPost) { return false; }
    return true;
  };

  var twitterPostConfirm = function() {
    var twitterPostEnabled, twitterAutoPost, twitterPosted, editAutoPost;

    twitterPostEnabled = <%== @item.class.include?(Cms::Addon::SnsPoster) %>;
    twitterAutoPost = $('[name="item[twitter_auto_post]"]').length && ($('[name="item[twitter_auto_post]"]').val() == "active");
    editAutoPost = $('[name="item[edit_auto_post]"]').length && ($('[name="item[edit_auto_post]"]').val() == "active");

    <% item = (@item.respond_to?(:master) && @item.master) ? @item.master : @item %>
    twitterPosted = <%== item.respond_to?(:twitter_posted) && item.twitter_posted.present? %>;

    if (!twitterPostEnabled) { return false; }
    if (!twitterAutoPost) { return false; }
    if (twitterPosted && !editAutoPost) { return false; }
    return true;
  };

  var facebookPostConfirm = function() {
    var categoryChecked;

    categoryChecked = $('[name="item[category_ids][]"][value="3536"]').prop("checked");
    if (!categoryChecked) { return false; }
    return true;
  }

  $(".publish_save").data("sns-post-confirmation", function() {
    var messages

    messages = [];
    if (linePostConfirm()) {
      messages.push("<%= t("cms.confirm.line_post_enabled") %>")
    }
    if (twitterPostConfirm()) {
      messages.push("<%= t("cms.confirm.twitter_post_enabled") %>")
    }
    if (facebookPostConfirm()) {
      messages.push("<%= t("cms.confirm.facebook_post_enabled") %>")
    }
    return messages;
  });

<% end %>
