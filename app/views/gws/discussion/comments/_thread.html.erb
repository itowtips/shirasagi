<%= jquery do %>
$('a.ajax-box').data('on-select', function($item) {
  var selected = $.colorbox.element().closest(".comment-files").find(".selected-files");
  var fileId = $item.data('id');
  var humanizedName = $item.data('humanized-name');

  span  = $('<span></span>');
  img   = $('<img src="/assets/img/gws/ic-file.png" alt="" />');
  a     = $('<a target="_blank"></a>');
  input = $('<input type="hidden" name="item[file_ids][]" class="file-id" />');
  icon = $("<i class=\"material-icons md-18 md-inactive deselect\">close</i>");

  span.attr("data-file-id", fileId);
  span.attr("id", "file-" + fileId);
  a.text(humanizedName);
  a.attr("href", "/.u1/apis/temp_files/" + fileId + "/view");
  input.attr("value", fileId);
  icon.on("click", function(e) {
    $(this).parent("span").remove();
    return false;
  });

  span.append(img);
  span.append(a);
  span.append(icon);
  span.append(input);

  $(selected).show();
  $(selected).append(span);
  return $.colorbox.close();
});
<% end %>

<% main_topic = (topic.main_topic ? topic.main_topic : topic) %>
<div class="addon-view">
  <div class="addon-head">
    <h2><%= link_to topic.name, gws_discussion_topic_comment_path(id: topic.id) %></h2>
  </div>
  <div class="addon-body">
    <dl class="see">
      <dd class="wide">
        <!-- <div class="no"><%= 1 %></div> -->
        <div class="markdown-body">
          <%= main_topic.html %>
        </div>
        <% if main_topic.files.present? %>
        <div class="files">
          <% main_topic.files.each do |file| %>
          <span id="file-<%= file.id %>">
          <img src="/assets/img/gws/ic-file.png" alt="" />
            <%= link_to file.humanized_name, file.url, class: "icon-#{file.extname}", target: '_blank' %>
          </span>
          <% end %>
        </div>
        <% end %>
        <div class="datetime updated">
          <%= topic.updated.strftime("%Y/%m/%d %H:%M") %>
        </div>
      </dd>
    </dl>
  </div>

  <% children = topic.children %>
  <% children_size = children.size %>
  <% if limit > 0 %>
    <% comments = topic.children.limit(limit).reverse.to_a %>
  <% else %>
    <% comments = topic.children.reverse.to_a %>
  <% end %>
  <% offset = children_size - comments.size %>
  <% if children_size > comments.size %>
    <div style="background: #f2f2f2; border: 1px solid #d0d0d0; border-left: hidden; border-right: hidden;">...</div>
  <% end %>

  <% comments.each_with_index do |comment, i| %>
    <div class="addon-body">
      <dl class="see">
        <dd class="wide">
          <!-- <div class="no"><%= offset + i + 2 %></div> -->
          <div class="markdown-body">
            <%= comment.html %>
          </div>
          <% if comment.files.present? %>
          <div class="files">
            <% comment.files.each do |file| %>
              <span id="file-<%= file.id %>">
                <img src="/assets/img/gws/ic-file.png" alt="" />
                <%= link_to file.humanized_name, file.url, class: "icon-#{file.extname}", target: '_blank' %>
              </span>
            <% end %>
          </div>
          <% end %>
          <div class="datetime updated">
            <%= comment.updated.strftime("%Y/%m/%d %H:%M") %>
          </div>
        </dd>
      </dl>
    </div>
  <% end %>

  <div class="addon-body">
    <% if @new_comment && @new_comment.parent_id == main_topic.id %>
      <%= error_messages_for :new_comment %>
    <% end %>
    <div class="ss-addon-markdown">
      <div class="ss-addon-markdown-toolbar">
        <%= f.select :text_type, topic.text_type_options, {}, { value: 'plain', class: "ss-addon-markdown-type" } %>
      </div>
      <div class="ss-addon-markdown-content">
        <%= f.text_area :text, value: "", class: "markdown", style: "height: 240px;", required: true %>
      </div>
    </div>
    <div class="comment-files">
      <%= f.hidden_field "file_ids[]", value: "" %>
      <span class="upload-menu-new">
        <%= link_to t('ss.links.upload'), sns_apis_temp_files_path(@cur_user), class: "ajax-box btn" %>
      </span>
      <!--
      <span class="upload-menu-select">
        <%= link_to t("sns.user_file"), sns_apis_user_files_path(@cur_user), class: "ajax-box btn" %>
        <%= link_to t("modules.gws/share"), gws_apis_files_path, class: "ajax-box btn" %>
      </span>
      -->
      <div class="selected-files files" style="display: none;"></div>
    </div>
    <div class="menu">
      <%= f.submit "返信する", class: 'btn primary' %>
      <%= f.submit "編集する", class: 'btn primary' %>
      <%= f.submit "削除する", class: 'btn primary' %>
    </div>
  </div>
</div>