<% main_topic = (topic.main_topic ? topic.main_topic : topic) %>
<div class="addon-view">
  <div class="addon-head"><h2><%= topic.name %></h2></div>
  <div class="addon-body">
    <dl class="see">
      <dd class="wide">
        <span class="no"><%= 1 %></span>
        <div class="markdown-body">
          <%= main_topic.html %>
        </div>
        <% if main_topic.files.present? %>
        <div class="files">
          <% main_topic.files.each do |file| %>
          <span id="file-<%= file.id %>">
          <img src="/assets/img/gws/ic-file.png" alt="" />
            <%= link_to file.humanized_name, file.url, class: "icon-#{file.extname}", target: '_blank' %>
          </span>
          <% end %>
        </div>
        <% end %>
      </dd>
    </dl>
  </div>

  <% children_size = topic.children.size %>
  <% comments = topic.children.limit(5).reverse.to_a %>
  <% offset = children_size - comments.size %>
  <% if children_size > comments.size %>
    <div style="background: #f2f2f2; border: 1px solid #d0d0d0; border-left: hidden; border-right: hidden;">...</div>
  <% end %>

  <% comments.each_with_index do |comment, i| %>
      <div class="addon-body">
        <dl class="see">
          <dd class="wide">
            <span class="no"><%= offset + i + 2 %></span>
            <div class="markdown-body">
              <%= comment.html %>
            </div>

            <% if comment.files.present? %>
              <div class="files">
                <% comment.files.each do |file| %>
                  <span id="file-<%= file.id %>">
                    <img src="/assets/img/gws/ic-file.png" alt="" />
                    <%= link_to file.humanized_name, file.url, class: "icon-#{file.extname}", target: '_blank' %>
                  </span>
                <% end %>
              </div>
            <% end %>
          </dd>
        </dl>
      </div>
  <% end %>

  <div class="addon-body">
    <div class="ss-addon-markdown">
      <div class="ss-addon-markdown-toolbar">
        <%= f.select :text_type, topic.text_type_options, {},  class: "ss-addon-markdown-type" %>
      </div>
      <div class="ss-addon-markdown-content">
        <%= f.text_area :text, class: "markdown", style: "height: 240px;" %>
      </div>
    </div>

    <dd class="wide">
      <%= f.hidden_field "file_ids[]", value: "" %>
      <span class="upload-menu-new">
          <%= link_to t('ss.links.upload'), sns_apis_temp_files_path(@cur_user), class: "ajax-box btn" %>
        </span>
      <span class="upload-menu-select">
          <%= link_to t("sns.user_file"), sns_apis_user_files_path(@cur_user), class: "ajax-box btn" %>
        <%= link_to t("modules.gws/share"), gws_apis_files_path, class: "ajax-box btn" %>
        </span>
      <div id="selected-files"></div>
    </dd>

    <div class="menu">
      <%= f.submit t("ss.buttons.save"), class: 'btn primary' %>
    </div>
  </div>
</div>