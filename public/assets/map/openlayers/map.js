(function(){this.Openlayers_Map=function(){function e(e,r){null==r&&(r={}),this.canvas=e,this.opts=r,this.markerFeature=null,this.markerLayer=null,this.popup=null,this.markerIcon="/assets/img/map-marker.png",this.render()}return e.prototype.render=function(){return this.initMap(),this.initPopup(),this.opts.markers&&this.renderMarkers(this.opts.markers),this.resize(),this.renderEvents()},e.prototype.createLayers=function(e){var r,t,o,n,a,i,s,p;for(o=[],r=0,n=e.length;r<n;r++)s=(a=e[r]).source,p=a.url,i=a.projection,t=new ol.layer.Tile({source:new ol.source[s]({url:p,projection:i})}),o.push(t);return o},e.prototype.initMap=function(){var e,r;return e=this.opts.center||[138.252924,36.204824],(r=this.opts.layers)||(r=[{source:"XYZ",url:"http://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(r),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(e,"EPSG:4326","EPSG:3857"),maxZoom:18,zoom:this.opts.zoom||10}),logo:!0})},e.prototype.initPopup=function(){var o,e;return $("body").append('<div id="marker-popup"><div class="closer"></div><div class="content"></div></div>'),this.popup=$("#marker-popup"),this.popup.hide(),this.popupOverlay=new ol.Overlay({element:this.popup.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),this.map.addOverlay(this.popupOverlay),this.map.on("pointermove",(o=this,function(e){var r,t;if(!e.dragging)return t=o.map.getEventPixel(e.originalEvent),r=o.map.hasFeatureAtPixel(t)?"pointer":"",o.map.getTarget().style.cursor=r;o.popup.hide()})),this.popup.find(".closer").on("click",(e=this,function(){return e.popupOverlay.setPosition(void 0),$(e).blur(),!1}))},e.prototype.showPopup=function(e,r){var t;if(t=e.get("markerHtml"))return this.popup.find(".content").html(t),this.popup.show(),this.popupOverlay.setPosition(r);this.popup.hide()},e.prototype.renderEvents=function(){return this.map.on("click",(t=this,function(e){var r;(r=t.map.forEachFeatureAtPixel(e.pixel,function(e){return e}))&&t.showPopup(r,e.coordinate)}));var t},e.prototype.createMarkerStyle=function(e){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:e})})},e.prototype.setMarker=function(e,r){var t,o,n,a,i,s,p;return null==r&&(r={}),o=this.markerIcon,r.image&&(o=r.image),p=this.createMarkerStyle(o),n=[r.loc[1],r.loc[0]],(t=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(n,"EPSG:4326","EPSG:3857")),markerId:null!=(a=r.id)?a:null,markerHtml:null!=(i=r.html)?i:null,category:null!=(s=r.category)?s:null,iconSrc:o})).setStyle(p),this.markerLayer?this.markerLayer.getSource().addFeature(t):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[t]})}),this.map.addLayer(this.markerLayer)),t},e.prototype.getMarker=function(r){var t;return t=null,this.markerLayer&&this.markerLayer.getSource().forEachFeature(function(e){if(e.get("markerId")===r)return t=e}),t},e.prototype.getMarkers=function(){return this.markerLayer.getSource().getFeatures()},e.prototype.setCenter=function(e){return this.map.getView().setCenter(ol.proj.transform(e,"EPSG:4326","EPSG:3857"))},e.prototype.setZoom=function(e){return this.map.getView().setZoom(e)},e.prototype.renderMarkers=function(e){var r,t,o,n,a,i,s,p,u,l,c,h,m;for(o in c=[],e)t="/assets/img/map-marker.png",(n=e[o]).image&&(t=n.image),h=this.createMarkerStyle(t),a="",i=n.name,m=n.text,i&&(a+="<p>"+i+"</p>"),m&&$.each(m.split(/[\r\n]+/),function(){return this.match(/^https?:\/\//)?a+='<p><a href="'+this+'">'+this+"</a></p>":a+="<p>"+this+"</p>"}),s=[n.loc[1],n.loc[0]],(r=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(s,"EPSG:4326","EPSG:3857")),markerId:null!=(p=n.id)?p:o,markerHtml:null!=(u=n.html)?u:a,category:null!=(l=n.category)?l:null,iconSrc:t})).setStyle(h),this.markerLayer?c.push(this.markerLayer.getSource().addFeature(r)):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[r]})}),c.push(this.map.addLayer(this.markerLayer)));return c},e.prototype.resize=function(){var e;if(this.markerLayer)return e=this.markerLayer.getSource().getExtent(),this.map.getView().fit(e,this.map.getSize())},e}()}).call(this);